[gd_scene load_steps=52 format=3 uid="uid://cww17u4c26p4h"]

[ext_resource type="Texture2D" uid="uid://cnu48pc3vqrom" path="res://Assets/Finales/CloverAnim1.png" id="1_hkrqw"]
[ext_resource type="Texture2D" uid="uid://nmx8al30ti8y" path="res://Assets/Temporales/image.jpg" id="1_s1vyc"]
[ext_resource type="Texture2D" uid="uid://sxk0hx56053o" path="res://Assets/Finales/WhiteM.png" id="1_vgb05"]
[ext_resource type="PackedScene" uid="uid://wb43sj03rdhh" path="res://Components/interacting_component.tscn" id="2_47pop"]
[ext_resource type="Texture2D" uid="uid://5wkgp4r1su53" path="res://Assets/Finales/CloverAnim2.png" id="2_u3qvb"]
[ext_resource type="PackedScene" uid="uid://d4neeerux0e3y" path="res://Characters/npc.tscn" id="3_7khpe"]
[ext_resource type="Texture2D" uid="uid://ceqbewssreve3" path="res://Assets/Finales/CloverAnim3.png" id="3_u4s5u"]
[ext_resource type="Texture2D" uid="uid://bq788l0mp1uib" path="res://Assets/Finales/background.png" id="4_1ygjx"]
[ext_resource type="Texture2D" uid="uid://0a0ybiqr5uw7" path="res://Assets/Finales/CloverAmin4.png" id="4_gourd"]
[ext_resource type="PackedScene" uid="uid://tqvckr0nktmj" path="res://Scenes/dialogTestScene/PruebaDialogo.tscn" id="5_1ygjx"]
[ext_resource type="Texture2D" uid="uid://cbx65b0ypyejg" path="res://Assets/Finales/PobCont.png" id="7_3tr1f"]
[ext_resource type="FontFile" uid="uid://cvtyjvr7vc0pi" path="res://Assets/Fonts/lucidagrande-bold.otf" id="7_idgxt"]
[ext_resource type="Script" uid="uid://ddfrxsmxjnr82" path="res://Scenes/Ui.cs" id="7_ukfro"]
[ext_resource type="Texture2D" uid="uid://dkureqhew4ajb" path="res://Assets/Temporales/siluetaOveja.png" id="8_otljr"]
[ext_resource type="Texture2D" uid="uid://clgnafno3ilx2" path="res://Assets/Temporales/moneda.png" id="9_tcxub"]
[ext_resource type="Texture2D" uid="uid://brpdgyhsdth5m" path="res://Assets/Finales/DineroCont.png" id="10_3tr1f"]
[ext_resource type="FontFile" uid="uid://buklh0o58ew5g" path="res://Assets/Fonts/lucidagrande.ttf" id="11_2bx17"]
[ext_resource type="PackedScene" uid="uid://b0hglxp0cy1mk" path="res://Scenes/Votacion.tscn" id="13_3tr1f"]
[ext_resource type="PackedScene" uid="uid://cdof2mqmvfv4" path="res://Buildings/fountain/fountain.tscn" id="13_sjf4i"]
[ext_resource type="Texture2D" uid="uid://w62drei7bai1" path="res://Assets/Finales/redBar.png" id="14_1hhg6"]
[ext_resource type="Texture2D" uid="uid://dfg4f6dvn7ht1" path="res://Assets/Finales/neutralBar.png" id="14_xwpop"]
[ext_resource type="Texture2D" uid="uid://bwaaa0qwotmul" path="res://Assets/Finales/greenBar.png" id="15_lvywo"]
[ext_resource type="Texture2D" uid="uid://g0fxvehubyq2" path="res://Assets/Finales/BarraBase.png" id="16_lvywo"]
[ext_resource type="PackedScene" uid="uid://dxhd7dnnpbwgc" path="res://Buildings/shop/shop.tscn" id="20_b0xse"]
[ext_resource type="PackedScene" uid="uid://dof62bbfme1oo" path="res://Buildings/shop/ShopUI.tscn" id="21_uoy6p"]
[ext_resource type="Texture2D" uid="uid://bht5ffdifhqkt" path="res://Assets/Temporales/tienda_interior.png" id="22_gnnw3"]
[ext_resource type="Script" uid="uid://dxak12m63mq8d" path="res://Buildings/shop/ShopItemData.gd" id="23_gnnw3"]
[ext_resource type="Texture2D" uid="uid://cqrhfi5pstj3q" path="res://Assets/Finales/trebol.png" id="24_7d6da"]
[ext_resource type="Texture2D" uid="uid://dqkvkoq57338h" path="res://Assets/Finales/trebolOveja.PNG" id="25_vgb05"]
[ext_resource type="PackedScene" uid="uid://bakl3atutqoh4" path="res://Buildings/house/house.tscn" id="26_5xohv"]
[ext_resource type="Texture2D" uid="uid://dvvxepepq1qrc" path="res://Assets/Finales/cascos.png" id="26_vgb05"]
[ext_resource type="PackedScene" uid="uid://bsh0cq5kk81o8" path="res://Buildings/house/HouseUI.tscn" id="27_2u5nn"]
[ext_resource type="Texture2D" uid="uid://djuhycwhaun4w" path="res://Assets/Finales/cascosOveja.png" id="27_qrccw"]
[ext_resource type="PackedScene" uid="uid://xwfgav6lvtdl" path="res://Buildings/fountain/votingPlace.tscn" id="28_esuwq"]
[ext_resource type="PackedScene" uid="uid://b7yfew4u7r5il" path="res://Buildings/fountain/library.tscn" id="29_fmqb3"]

[sub_resource type="GDScript" id="GDScript_s1vyc"]
script/source = "extends CharacterBody3D

@export var speed: float = 100.0
@export var moral: int = 0
@export var activity: int = 0
@onready var sheep_sprite = $Accesory

@export var walk_frames: Array[Texture2D]   # sprites del walk
@export var idle_frame: Texture2D           # sprite idle

@onready var sheep_anim = $Sheep          # AHORA se apunta al sprite correcto

var frame_index := 0
var frame_timer := 0.0
var frame_speed := 0.2   # segundos por frame

func get_input() -> void:
	# no procesar input si el movimiento está bloqueado
	if not GameState.can_move:
		print(\"jasfjasfja\")
		return

	var input_dir = Vector3.ZERO
	
	# Dir
	if Input.is_action_pressed(\"Up\"):
		input_dir.z -= 1
	if Input.is_action_pressed(\"Down\"):
		input_dir.z += 1
	if Input.is_action_pressed(\"Left\"):
		input_dir.x -= 1
	if Input.is_action_pressed(\"Right\"):
		input_dir.x += 1

	input_dir = input_dir.normalized()

	velocity.x = input_dir.x * speed
	velocity.z = input_dir.z * speed
	

func _physics_process(delta):
	# si el movimiento está bloqueado, detener al personaje completamente
	if not GameState.can_move:
		velocity = Vector3.ZERO
		move_and_slide()
		set_idle_sprite()  # <-- aquí ponemos el sprite idle
		return

	get_input()
	move_and_slide()

	# Llamadas a animación
	animate_walk(delta)  # animar caminata según velocidad
	flip_sprite()       # voltear sprite si va izquierda/derecha
	$Camera_Controller.position = lerp($Camera_Controller.position, position, 0.1)
	
	
func change_moral(amount: int) -> void:
	moral += amount
	moral = clamp(moral, -100, 100) # Entre -100 y 100 por ahora
	print(\"Nueva moral:\", moral)

func set_moral(value: int) -> void:

	moral = clamp(value, 0, 100)
	print(\"Moral establecida a:\", moral)

func change_activity(amount: int) -> void:
	activity += amount
	activity = clamp(activity, -100, 100) # Entre -100 y 100 por ahora
	print(\"Actividad:\", activity)

func set_activity(value: int) -> void:

	activity = clamp(value, 0, 100)
	print(\"Actividad establecida a:\", activity)

func set_player_sprite(new_texture: Texture2D):
	if not sheep_sprite:
		print(\"Error: 'Sheep' Sprite3D node no encontrado.\")
		return

	if new_texture:
		sheep_sprite.texture = new_texture
		print(\"Player sprite actualizado.\")
	else:
		print(\"Error: Se pasó una textura nula.\")
		
func animate_walk(delta: float) -> void:
	if velocity.length() < 0.1:
		set_idle_sprite()
		return

	frame_timer += delta
	if frame_timer >= frame_speed:
		frame_timer = 0.0
		frame_index = (frame_index + 1) % walk_frames.size()

		if sheep_anim and walk_frames.size() > 0:
			sheep_anim.texture = walk_frames[frame_index]


func set_idle_sprite():
	if idle_frame and sheep_anim:
		sheep_anim.texture = idle_frame
		frame_index = 0
		frame_timer = 0


func flip_sprite():
	if abs(velocity.x) > 0.1:
		if velocity.x > 0:
			sheep_anim.scale.x = -abs(sheep_anim.scale.x)  
		else:
			sheep_anim.scale.x = abs(sheep_anim.scale.x) 
"

[sub_resource type="BoxShape3D" id="BoxShape3D_s1vyc"]

[sub_resource type="PlaneMesh" id="PlaneMesh_s1vyc"]

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_7khpe"]
shading_mode = 0
albedo_texture = ExtResource("4_1ygjx")

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_2am7v"]
texture = ExtResource("7_3tr1f")

[sub_resource type="LabelSettings" id="LabelSettings_otljr"]
font = ExtResource("7_idgxt")
font_size = 38
font_color = Color(0.23137255, 0.07450981, 0.015686275, 1)

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_xwpop"]
texture = ExtResource("10_3tr1f")

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_sjf4i"]
bg_color = Color(0.81960785, 0.6431373, 0.53333336, 1)
border_width_left = 10
border_width_top = 10
border_width_right = 10
border_width_bottom = 10
border_color = Color(0.3504598, 0.23772365, 0.16553533, 1)
corner_radius_top_left = 50
corner_radius_top_right = 50
corner_radius_bottom_right = 50
corner_radius_bottom_left = 50

[sub_resource type="LabelSettings" id="LabelSettings_sjf4i"]
font = ExtResource("7_idgxt")
font_size = 56
font_color = Color(0.34901962, 0.23921569, 0.16470589, 1)

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_ukfro"]
bg_color = Color(0.39215687, 0.27450982, 0.19607843, 1)

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_b0xse"]
texture = ExtResource("14_xwpop")

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_jhioe"]
texture = ExtResource("14_1hhg6")

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_1hhg6"]
texture = ExtResource("15_lvywo")

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_lvywo"]
texture = ExtResource("16_lvywo")

[sub_resource type="Resource" id="Resource_mgg7j"]
script = ExtResource("23_gnnw3")
item_id = "lazo_rojo"
dialog_event = "Shop_Round0"
cost = 15
texture = ExtResource("25_vgb05")
itemInShop = ExtResource("24_7d6da")
metadata/_custom_type_script = "uid://dxak12m63mq8d"

[sub_resource type="Resource" id="Resource_yiynj"]
script = ExtResource("23_gnnw3")
item_id = "sombrero"
dialog_event = "Shop_Round1"
cost = 20
texture = ExtResource("27_qrccw")
itemInShop = ExtResource("26_vgb05")
metadata/_custom_type_script = "uid://dxak12m63mq8d"

[node name="TrialScene" type="Node3D"]

[node name="Player" type="CharacterBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 0.9999999, 0, 0, 0, 0.9999999, -83, 10, 7)
motion_mode = 1
script = SubResource("GDScript_s1vyc")
walk_frames = Array[Texture2D]([ExtResource("1_hkrqw"), ExtResource("2_u3qvb"), ExtResource("3_u4s5u"), ExtResource("4_gourd")])
idle_frame = ExtResource("1_vgb05")

[node name="Sheep" type="Sprite3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 0.8660254, 0.5, 0, -0.5, 0.8660254, 0, 0, 0)
layers = 2
pixel_size = 0.05
texture = ExtResource("1_vgb05")

[node name="Accesory" type="Sprite3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 0.8660254, 0.5, 0, -0.5, 0.8660254, 0, 0, 1.9554672)
layers = 2
pixel_size = 0.05

[node name="CollisionShape3D" type="CollisionShape3D" parent="Player"]
transform = Transform3D(15, 0, 0, 0, 15, 0, 0, 0, 15, 0, 0, 0)
shape = SubResource("BoxShape3D_s1vyc")
debug_color = Color(0.88235295, 0, 0.5137255, 1)

[node name="Camera_Controller" type="Node3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 0.9999999, 0, 0, 0, 0.9999999, 0, 10, 7)
top_level = true

[node name="Camera_Target" type="Node3D" parent="Player/Camera_Controller"]
transform = Transform3D(1, 0, 0, 0, 0.70710677, 0.70710677, 0, -0.70710677, 0.70710677, 0, 260, 240)

[node name="Camera3D" type="Camera3D" parent="Player/Camera_Controller/Camera_Target"]
transform = Transform3D(1, 0, 0, 0, 1.0000002, 0, 0, 0, 1.0000002, 0, 0, 0)
doppler_tracking = 2
current = true
fov = 30.0
near = 0.01
far = 1000.0

[node name="InteractingComponent" parent="Player" instance=ExtResource("2_47pop")]
transform = Transform3D(50, 0, 0, 0, 50, 0, 0, 0, 50, 0, 0, 0)

[node name="Background" type="Sprite3D" parent="."]
transform = Transform3D(1, -1.7484555e-07, 7.1054274e-15, 0, -4.3711385e-08, -1, 1.7484554e-07, 1, -4.3711385e-08, 2.1316282e-14, -3, -1.3113416e-07)
visible = false
visibility_range_begin = 30.25
flip_v = true
pixel_size = 0.15
texture = ExtResource("1_s1vyc")

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(0.19041917, -0.48103794, 0.4233233, 0, 0.7826081, 0.43576026, -0.23182008, -0.39512902, 0.3477217, 214.202, 61.675, 131.31)
visible = false

[node name="MeshInstance3D" type="MeshInstance3D" parent="."]
transform = Transform3D(300, 0, 0, 0, 300, 0, 0, 0, 250, 2.1316282e-14, -3, -1.3113416e-07)
mesh = SubResource("PlaneMesh_s1vyc")
skeleton = NodePath("../Background")
surface_material_override/0 = SubResource("StandardMaterial3D_7khpe")

[node name="NPC1" parent="." instance=ExtResource("3_7khpe")]
transform = Transform3D(5, 0, 0, 0, 5, 0, 0, 0, 5, -95, 10.489868, -82)
npc_id = 1

[node name="UI" type="CanvasLayer" parent="."]
process_mode = 3
script = ExtResource("7_ukfro")

[node name="nPoblacion" type="Panel" parent="UI"]
custom_minimum_size = Vector2(100, 0)
offset_left = 26.0
offset_top = 7.000002
offset_right = 172.0
offset_bottom = 95.0
scale = Vector2(0.8, 0.8)
theme_override_styles/panel = SubResource("StyleBoxTexture_2am7v")

[node name="Label" type="Label" parent="UI/nPoblacion"]
layout_mode = 1
anchors_preset = 6
anchor_left = 1.0
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
offset_left = -78.0
offset_top = -12.0
offset_right = -24.666672
offset_bottom = 29.0
grow_horizontal = 0
grow_vertical = 2
theme_override_colors/font_color = Color(0, 0, 0, 1)
theme_override_font_sizes/font_size = 56
text = "55"
label_settings = SubResource("LabelSettings_otljr")
horizontal_alignment = 1
vertical_alignment = 1

[node name="TextureRect" type="TextureRect" parent="UI/nPoblacion"]
visible = false
modulate = Color(0.23137255, 0.07450981, 0.015686275, 1)
layout_mode = 0
offset_left = 20.833332
offset_top = 13.958342
offset_right = 64.24333
offset_bottom = 51.83834
texture = ExtResource("8_otljr")
expand_mode = 1

[node name="nDinero" type="Panel" parent="UI"]
custom_minimum_size = Vector2(100, 0)
offset_left = 24.0
offset_top = 80.0
offset_right = 173.0
offset_bottom = 164.0
scale = Vector2(0.8, 0.8)
theme_override_styles/panel = SubResource("StyleBoxTexture_xwpop")

[node name="Label" type="Label" parent="UI/nDinero"]
layout_mode = 1
anchors_preset = 6
anchor_left = 1.0
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
offset_left = -79.0
offset_top = -12.0
offset_right = -24.0
offset_bottom = 26.0
grow_horizontal = 0
grow_vertical = 2
theme_override_colors/font_color = Color(0, 0, 0, 1)
theme_override_font_sizes/font_size = 56
text = "55"
label_settings = SubResource("LabelSettings_otljr")
horizontal_alignment = 1
vertical_alignment = 1

[node name="TextureRect" type="TextureRect" parent="UI/nDinero"]
visible = false
layout_mode = 0
offset_left = 19.999987
offset_top = 13.1828785
offset_right = 60.374985
offset_bottom = 55.572876
texture = ExtResource("9_tcxub")
expand_mode = 1

[node name="PausePanel" type="Panel" parent="UI"]
custom_minimum_size = Vector2(600, 400)
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/panel = SubResource("StyleBoxFlat_sjf4i")

[node name="Pause" type="Label" parent="UI/PausePanel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -186.0
offset_top = 50.0
offset_right = 186.0
offset_bottom = 106.0
grow_horizontal = 2
text = "PAUSE_TITLE"
label_settings = SubResource("LabelSettings_sjf4i")
horizontal_alignment = 1
vertical_alignment = 1

[node name="VBoxContainer" type="VBoxContainer" parent="UI/PausePanel"]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -250.0
offset_top = -59.0
offset_right = 250.0
offset_bottom = 101.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/separation = 40

[node name="MainMenuButton" type="Button" parent="UI/PausePanel/VBoxContainer"]
custom_minimum_size = Vector2(500, 60)
layout_mode = 2
theme_override_fonts/font = ExtResource("11_2bx17")
theme_override_font_sizes/font_size = 30
theme_override_styles/normal = SubResource("StyleBoxFlat_ukfro")
text = "MAIN_MENU_BUTTON"

[node name="ResumeButton" type="Button" parent="UI/PausePanel/VBoxContainer"]
custom_minimum_size = Vector2(500, 60)
layout_mode = 2
theme_override_fonts/font = ExtResource("11_2bx17")
theme_override_font_sizes/font_size = 30
theme_override_styles/normal = SubResource("StyleBoxFlat_ukfro")
text = "RESUME_BUTTON"

[node name="OpinionBar" type="Control" parent="UI"]
custom_minimum_size = Vector2(681, 69)
layout_mode = 3
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -270.0
offset_right = 412.0
offset_bottom = 71.0
grow_horizontal = 2
scale = Vector2(0.8, 0.8)

[node name="NeutralBar" type="Panel" parent="UI/OpinionBar"]
custom_minimum_size = Vector2(649, 60)
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -314.0
offset_top = -15.25
offset_right = 335.0
offset_bottom = 44.75
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/panel = SubResource("StyleBoxTexture_b0xse")

[node name="RedBar" type="Panel" parent="UI/OpinionBar"]
custom_minimum_size = Vector2(10, 60)
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -311.0
offset_top = -14.25
offset_right = -48.50006
offset_bottom = 45.75
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/panel = SubResource("StyleBoxTexture_jhioe")

[node name="GreenBar" type="Panel" parent="UI/OpinionBar"]
custom_minimum_size = Vector2(10, 60)
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = 134.0
offset_top = -15.5
offset_right = 345.25
offset_bottom = 44.5
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/panel = SubResource("StyleBoxTexture_1hhg6")

[node name="Deco" type="Panel" parent="UI/OpinionBar"]
custom_minimum_size = Vector2(681, 71)
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -324.5
offset_top = -23.0
offset_right = 356.5
offset_bottom = 46.0
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/panel = SubResource("StyleBoxTexture_lvywo")

[node name="PruebaDialogo" parent="." instance=ExtResource("5_1ygjx")]

[node name="Fountain" parent="." instance=ExtResource("13_sjf4i")]
transform = Transform3D(10, 0, 0, 0, 10, 0, 0, 0, 10, 6, 37, 6)
current_dialog_event = "Fountain"

[node name="NPC2" parent="." instance=ExtResource("3_7khpe")]
transform = Transform3D(5, 0, 0, 0, 5, 0, 0, 0, 5, 130, 10.489868, 58)
npc_id = 2

[node name="ShopBuilding" parent="." instance=ExtResource("20_b0xse")]
transform = Transform3D(10, 0, 0, 0, 10, 0, 0, 0, 10, 250, 8.293777, 82.49446)
shop_ui_scene = ExtResource("21_uoy6p")
shop_background_image = ExtResource("22_gnnw3")
round_items = Array[ExtResource("23_gnnw3")]([SubResource("Resource_mgg7j"), SubResource("Resource_yiynj")])

[node name="HouseBuilding" parent="." instance=ExtResource("26_5xohv")]
transform = Transform3D(40, 0, 0, 0, 40, 0, 0, 0, 40, 0, 33.94557, 214.67339)
house_ui_scene = ExtResource("27_2u5nn")
house_background_image = ExtResource("22_gnnw3")

[node name="Votacion" parent="." instance=ExtResource("13_3tr1f")]

[node name="VotingPlace" parent="." instance=ExtResource("28_esuwq")]
transform = Transform3D(10, 0, 0, 0, 10, 0, 0, 0, 10, 0, 25, -222)
current_dialog_event = "VotePlaceRound1"

[node name="FlowerShop" parent="." instance=ExtResource("29_fmqb3")]
transform = Transform3D(10, 0, 0, 0, 10, 0, 0, 0, 10, -114, 35, -210)
current_dialog_event = "BookShop"
